import React from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '@/context/AuthContext';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';

const UserTypeSelectionPage: React.FC = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const { toast } = useToast();

  const handleRoleSelection = async (role: 'teacher' | 'school') => {
    if (!user) {
      toast({
        title: "–û—à–∏–±–∫–∞",
        description: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω",
        variant: "destructive",
      });
      return;
    }

    try {
      // Update user profile with selected role
      const { error: profileError } = await supabase
        .from('profiles')
        .update({ role })
        .eq('id', user.id);

      if (profileError) throw profileError;

      // Create role-specific profile
      if (role === 'school') {
        const { error: schoolError } = await supabase
          .from('school_profiles')
          .insert({
            id: user.id,
            school_name: user.user_metadata?.full_name || '–ù–æ–≤–∞—è —à–∫–æ–ª–∞',
            is_published: false
          });
        
        if (schoolError) throw schoolError;
        navigate('/school-dashboard');
      } else {
        const { error: teacherError } = await supabase
          .from('teacher_profiles')
          .insert({
            id: user.id,
            available: true
          });
        
        if (teacherError) throw teacherError;
        navigate('/teacher-dashboard');
      }

      toast({
        title: "–£—Å–ø–µ—à–Ω–æ!",
        description: `–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ ${role === 'teacher' ? '—É—á–∏—Ç–µ–ª—å' : '—à–∫–æ–ª–∞'}`,
      });

    } catch (error: any) {
      console.error('Role selection error:', error);
      toast({
        title: "–û—à–∏–±–∫–∞",
        description: error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å",
        variant: "destructive",
      });
    }
  };

  if (!user) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-2xl font-bold mb-4">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
          <p className="text-muted-foreground mb-4">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
          <Button onClick={() => navigate('/login')}>
            –í–æ–π—Ç–∏
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-background to-secondary/20 flex items-center justify-center p-4">
      <div className="w-full max-w-4xl">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é —Ä–æ–ª—å</h1>
          <p className="text-muted-foreground">
            –ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—à—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É?
          </p>
        </div>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Teacher Card */}
          <Card className="cursor-pointer hover:shadow-lg transition-all duration-300 hover:scale-105">
            <CardContent className="p-8 text-center">
              <div className="text-6xl mb-4">üë®‚Äçüè´</div>
              <h2 className="text-2xl font-bold mb-3">–£—á–∏—Ç–µ–ª—å</h2>
              <p className="text-muted-foreground mb-6">
                –ù–∞–π–¥–∏—Ç–µ —Ä–∞–±–æ—Ç—É –≤ —à–∫–æ–ª–∞—Ö, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏ –æ—Ç–∫–ª–∏–∫–∞–π—Ç–µ—Å—å –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏
              </p>
              <Button 
                onClick={() => handleRoleSelection('teacher')}
                className="w-full"
                size="lg"
              >
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ —É—á–∏—Ç–µ–ª—å
              </Button>
            </CardContent>
          </Card>

          {/* School Card */}
          <Card className="cursor-pointer hover:shadow-lg transition-all duration-300 hover:scale-105">
            <CardContent className="p-8 text-center">
              <div className="text-6xl mb-4">üè´</div>
              <h2 className="text-2xl font-bold mb-3">–®–∫–æ–ª–∞</h2>
              <p className="text-muted-foreground mb-6">
                –†–∞–∑–º–µ—â–∞–π—Ç–µ –≤–∞–∫–∞–Ω—Å–∏–∏, –∏—â–∏—Ç–µ —É—á–∏—Ç–µ–ª–µ–π –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞—è–≤–∫–∞–º–∏
              </p>
              <Button 
                onClick={() => handleRoleSelection('school')}
                className="w-full"
                size="lg"
              >
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ —à–∫–æ–ª–∞
              </Button>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
};

export default UserTypeSelectionPage;